generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== AUTH & USER MODELS ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  name          String?
  phone         String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  businesses    BusinessMember[]
  notifications Notification[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? 
  access_token      String? 
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? 
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== BUSINESS MODELS ====================

model Business {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  
  logo        String?
  email       String?
  phone       String?
  website     String?
  address     String?
  city        String?
  state       String?
  country     String   @default("Nigeria")
  currency    String   @default("NGN")
  timezone    String   @default("Africa/Lagos")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Store settings
  storeEnabled    Boolean @default(true)
  storeDomain     String? @unique
  storeTheme      Json?
  storeSeoTitle   String?
  storeSeoDesc    String? 

  // Subscription
  subscriptionId   String?
  subscriptionPlan SubscriptionPlan @default(FREE)
  subscriptionEnd  DateTime?

  members     BusinessMember[]
  locations   Location[]
  categories  Category[]
  products    Product[]
  customers   Customer[]
  orders      Order[]
  invoices    Invoice[]
  expenses    Expense[]
  discounts   Discount[]
  taxRates    TaxRate[]
}

model BusinessMember {
  id         String   @id @default(cuid())
  businessId String
  userId     String
  role       Role     @default(STAFF)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId])
}

model Location {
  id         String   @id @default(cuid())
  businessId String
  name       String
  address    String?
  city       String?
  state      String?
  phone      String?
  email      String?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business   Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  inventory  Inventory[]
  orders     Order[]
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  STAFF
}

enum SubscriptionPlan {
  FREE
  STARTER
  PRO
  GROWTH
  ENTERPRISE
}

// ==================== PRODUCT & INVENTORY MODELS ====================

model Category {
  id          String   @id @default(cuid())
  businessId  String
  name        String
  slug        String
  description String?
  image       String?
  parentId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@unique([businessId, slug])
}

model Product {
  id            String        @id @default(cuid())
  businessId    String
  categoryId    String?
  name          String
  slug          String
  description   String?       
  sku           String?
  barcode       String?
  price         Decimal       
  comparePrice  Decimal?      
  costPrice     Decimal?      
  taxable       Boolean       @default(true)
  trackQuantity Boolean       @default(true)
  status        ProductStatus @default(ACTIVE)
  images        String   @default("[]")
  tags          String   @default("[]")
  weight        Decimal?      
  weightUnit    String?       @default("kg")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  business   Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category   Category?        @relation(fields: [categoryId], references: [id])
  variants   ProductVariant[]
  inventory  Inventory[]
  orderItems OrderItem[]

  @@unique([businessId, slug])
  @@index([businessId, sku])
  @@index([businessId, barcode])
}

model ProductVariant {
  id         String   @id @default(cuid())
  productId  String
  name       String
  sku        String?
  barcode    String?
  price      Decimal  
  costPrice  Decimal? 
  options    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventory  Inventory[]
  orderItems OrderItem[]
}

model Inventory {
  id         String   @id @default(cuid())
  productId  String
  variantId  String?
  locationId String
  quantity   Int      @default(0)
  lowStock   Int      @default(5)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product  Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant  ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  location Location        @relation(fields: [locationId], references: [id], onDelete: Cascade)
  history  InventoryHistory[]

  @@unique([productId, variantId, locationId])
}

model InventoryHistory {
  id          String   @id @default(cuid())
  inventoryId String
  type        String
  quantity    Int
  note        String?
  createdAt   DateTime @default(now())

  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}

// ==================== CUSTOMER MODELS ====================

model Customer {
  id           String   @id @default(cuid())
  businessId   String
  email        String?
  phone        String?
  firstName    String
  lastName     String?
  company      String?
  address      String?
  city         String?
  state        String?
  country      String?
  notes        String?
  tags         String   @default("[]")
  totalOrders  Int      @default(0)
  totalSpent   Decimal  @default(0) 
  lastOrderAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  orders   Order[]
  invoices Invoice[]
  debts    Debt[]

  @@unique([businessId, email])
  @@index([businessId, phone])
}

model Debt {
  id         String   @id @default(cuid())
  customerId String
  orderId    String?  @unique
  amount     Decimal  
  paidAmount Decimal  @default(0) 
  dueDate    DateTime?
  status     DebtStatus @default(PENDING)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  order    Order?   @relation(fields: [orderId], references: [id])
}

enum DebtStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
}

// ==================== ORDER MODELS ====================

model Order {
  id             String       @id @default(cuid())
  businessId     String
  customerId     String?
  locationId     String?
  orderNumber    String
  status         OrderStatus  @default(PENDING)
  paymentStatus  PaymentStatus @default(UNPAID)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // Amounts
  subtotal       Decimal      
  discountAmount Decimal      @default(0) 
  taxAmount      Decimal      @default(0) 
  shippingAmount Decimal      @default(0) 
  total          Decimal      
  paidAmount     Decimal      @default(0) 

  // Shipping
  shippingAddress  Json?
  shippingMethod   String?
  trackingNumber   String?

  // Customer info (for guest orders)
  customerEmail    String?
  customerPhone    String?
  customerName     String?

  notes            String?     
  source           OrderSource @default(MANUAL)
  discountId       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  business   Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer   Customer?    @relation(fields: [customerId], references: [id])
  location   Location?    @relation(fields: [locationId], references: [id])
  discount   Discount?    @relation(fields: [discountId], references: [id])
  items      OrderItem[]
  payments   Payment[]
  invoice    Invoice?
  debt       Debt?

  @@unique([businessId, orderNumber])
  @@index([businessId, status])
  @@index([businessId, createdAt])
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String
  variantId  String?
  name       String
  sku        String?
  quantity   Int
  price      Decimal  
  costPrice  Decimal? 
  total      Decimal  
  createdAt  DateTime @default(now())

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIAL
  FULFILLED
  SHIPPED
  DELIVERED
}

enum OrderSource {
  MANUAL
  ONLINE
  POS
}

// ==================== PAYMENT MODELS ====================

model Payment {
  id        String        @id @default(cuid())
  orderId   String
  amount    Decimal       
  method    PaymentMethod
  reference String?
  status    String        @default("completed")
  metadata  Json?
  createdAt DateTime      @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  MOBILE_MONEY
  WALLET
  OTHER
}

// ==================== INVOICE MODELS ====================

model Invoice {
  id            String        @id @default(cuid())
  businessId    String
  customerId    String?
  orderId       String?       @unique
  invoiceNumber String
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime?
  issueDate     DateTime      @default(now())

  subtotal      Decimal       
  discountAmount Decimal      @default(0) 
  taxAmount     Decimal       @default(0) 
  total         Decimal       
  paidAmount    Decimal       @default(0) 

  notes         String?       
  terms         String?       
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  business Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer Customer?    @relation(fields: [customerId], references: [id])
  order    Order?       @relation(fields: [orderId], references: [id])
  items    InvoiceItem[]

  @@unique([businessId, invoiceNumber])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int
  price       Decimal  
  total       Decimal  

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

// ==================== DISCOUNT MODELS ====================

model Discount {
  id         String       @id @default(cuid())
  businessId String
  code       String
  name       String
  type       DiscountType
  value      Decimal      
  minPurchase Decimal?    
  maxUses    Int?
  usedCount  Int          @default(0)
  startsAt   DateTime?
  endsAt     DateTime?
  isActive   Boolean      @default(true)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  orders   Order[]

  @@unique([businessId, code])
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// ==================== TAX MODELS ====================

model TaxRate {
  id         String   @id @default(cuid())
  businessId String
  name       String
  rate       Decimal  
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// ==================== EXPENSE MODELS ====================

model Expense {
  id          String   @id @default(cuid())
  businessId  String
  category    String
  description String
  amount      Decimal  
  date        DateTime @default(now())
  receipt     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, date])
}

// ==================== NOTIFICATION MODELS ====================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}
